<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Raport MTS ATTAQWA 18 - Firebase Version</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1e40af',
                        secondary: '#64748b',
                        accent: '#0ea5e9'
                    }
                }
            }
        }
    </script>
    
    <!-- Print Styles for A4 -->
    <style>
    @media print {
        @page {
            size: A4;
            margin: 1cm;
        }

        body * {
            visibility: hidden;
        }

        #raportContent, #raportContent * {
            visibility: visible;
        }

        #raportContent {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            font-size: 12px;
        }

        .no-print {
            display: none !important;
        }
    }
    </style>

    <!-- Layout & Table Styles for Raport -->
    <style>
    body { font-family: "Times New Roman", serif; color: #000; }
    .page { width: 210mm; min-height: 297mm; padding: 10mm 8mm; margin: auto; }
    .header { display:flex; align-items:center; border-bottom:3px solid #000; padding-bottom:6px; margin-bottom:8px; }
    .logo { width:72px; height:72px; background:#eee; display:flex; align-items:center; justify-content:center; font-weight:bold; }
    .school-info { flex:1; text-align:center; line-height:1.05; }
    .school-info .title { font-size:16px; font-weight:bold; }
    .school-info .subtitle { font-size:12px; }
    .meta { display:flex; justify-content:space-between; margin:10px 0 14px 0; font-size:13px; }
    table.values { width:100%; border-collapse:collapse; font-size:13px; margin-bottom:12px; }
    table.values th, table.values td { border:1px solid #000; padding:6px 8px; }
    table.values th { background:#f2f2f2; }
    table.values td.center { text-align:center; }
    .signatures { display:flex; justify-content:space-between; margin-top:28px; font-size:13px; }
    .sig { width:30%; text-align:center; }
    .sig .name { margin-top:58px; font-weight:bold; text-decoration:underline; }
    .footer { margin-top:20px; font-size:11px; text-align:right; }
    @media screen { .page { box-shadow:0 0 0.5cm rgba(0,0,0,.15); margin:10mm auto; background:#fff; } }
    </style>

    
    <!-- Firebase SDK -->
    <script type="module">
        // ‚úÖ Perhatikan: Menambahkan setDoc untuk operasi set/write dokumen
        import { 
            initializeApp 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs, 
            doc, 
            updateDoc, 
            deleteDoc, 
            query, 
            where, 
            orderBy,
            setDoc // üí° BARU: Diperlukan untuk operasi set
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // ‚úÖ KONFIGURASI FIREBASE ANDA
        const firebaseConfig = {
            apiKey: "AIzaSyDrGCNggspGbWtevn2zMH5lnP7NkThKGlc",
            authDomain: "mts-attaqwa-18-eraport.firebaseapp.com",
            projectId: "mts-attaqwa-18-eraport",
            storageBucket: "mts-attaqwa-18-eraport.firebasestorage.app",
            messagingSenderId: "138446983019",
            appId: "1:138446983019:web:efdbbde2b3985ab425862e"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Make Firebase functions globally available
        window.db = db;
        window.collection = collection;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.doc = doc;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.query = query;
        window.where = where;
        window.orderBy = orderBy;
        window.setDoc = setDoc; // üí° BARU: Tambahkan setDoc ke window
        
        // Initialize app when Firebase is ready
        window.addEventListener('load', () => {
            if (window.initializeAppFirebase) {
                window.initializeAppFirebase();
            }
        });
    </script>

    <script>
            // Catatan: Asumsi variabel global seperti dataSiswa, dataNilai, currentUser, 
            // dan fungsi loadSiswaForNilai() sudah didefinisikan di tempat lain.
            
            // Download Template Excel (TIDAK ADA PERUBAHAN)
            function downloadTemplateNilai() {
                const kelas = document.getElementById('kelasSelect')?.value;
                const mapel = document.getElementById('mapelSelect')?.value;
                if (!kelas || !mapel) {
                    alert("‚ö†Ô∏è Pilih kelas dan mata pelajaran dulu!");
                    return;
                }

                let siswaKelas = Array.isArray(dataSiswa) ? dataSiswa.filter(s => (s.kelas || '').toString().trim() === kelas.toString().trim()) : [];
                if (siswaKelas.length === 0) {
                    alert("‚ö†Ô∏è Tidak ada siswa di kelas ini.");
                    return;
                }

                siswaKelas = siswaKelas.sort((a, b) => (a.nama || "").localeCompare(b.nama || "", 'id', { sensitivity: 'base' }));

                const rows = [["NIS", "Nama Siswa", "Nilai", "Deskripsi"]];
                siswaKelas.forEach(s => rows.push([s.nis, s.nama, "", ""]));

                const ws = XLSX.utils.aoa_to_sheet(rows);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Nilai");
                XLSX.writeFile(wb, `Template_Nilai_${kelas}_${mapel}.xlsx`);
            }


            // Upload Excel Nilai
            function uploadNilaiExcel() {
                const file = document.getElementById("uploadNilaiFile").files[0];
                if (!file) {
                    alert("‚ö†Ô∏è Pilih file Excel terlebih dahulu!");
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: "array" });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                    const mapel = document.getElementById('mapelSelect').value;
                    const asesmen = document.getElementById('asesmenSelect').value;

                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (!row[0]) continue; // skip baris kosong

                        const nis = String(row[0]).trim();
                        const nilai = row[2] || "";
                        const deskripsi = row[3] || "";

                        if (!nis) continue; // skip jika NIS kosong

                        const existing = dataNilai.find(n => 
                            n.nis === nis && n.mapel === mapel && n.asesmen === asesmen
                        );

                        if (existing) {
                            existing.nilai = parseInt(nilai) || 0;
                            existing.deskripsi = deskripsi;
                        } else {
                            dataNilai.push({
                                nis,
                                mapel,
                                asesmen,
                                nilai: parseInt(nilai) || 0,
                                deskripsi,
                                guru: currentUser?.name || "Guru"
                            });
                        }
                    }

                    alert("‚úÖ Data nilai berhasil diupload ke memori lokal!");
                    console.log("Data Nilai setelah upload (Lokal):", dataNilai);
                    loadSiswaForNilai(); // refresh tabel

                    // üöÄ PERBAIKAN UTAMA #1: Panggil fungsi penyimpanan setelah upload berhasil
                    simpanNilai(); 
                };
                reader.readAsArrayBuffer(file);
            }

            // Simpan Nilai ke Firebase
            async function simpanNilai() { // Gunakan async karena kita menggunakan await
                const mapel = document.getElementById('mapelSelect').value;
                const kelas = document.getElementById('kelasSelect').value;
                const asesmen = document.getElementById('asesmenSelect').value;

                if (!mapel || !kelas || !asesmen) {
                    alert("‚ö†Ô∏è Pilih mapel, kelas, dan asesmen dulu!");
                    return;
                }

                const nilaiToSave = dataNilai.filter(n => n.mapel === mapel && n.asesmen === asesmen);

                if (nilaiToSave.length === 0) {
                    alert("‚ö†Ô∏è Tidak ada data nilai untuk disimpan.");
                    return;
                }

                let successCount = 0;
                let errorCount = 0;

                // Proses penyimpanan secara paralel (Promise.all) untuk efisiensi
                const savePromises = nilaiToSave.map(n => {
                    if (!n.nis) {
                        console.error("‚ùå Data invalid, NIS kosong:", n);
                        errorCount++;
                        return Promise.resolve(); // Lanjutkan ke data berikutnya
                    }

                    const nisStr = String(n.nis).trim();
                    const docId = `${nisStr}_${mapel}_${asesmen}`;
                    
                    // üöÄ PERBAIKAN UTAMA #2: Menggunakan sintaks Modular (v9/v10): setDoc(doc(db, collectionName, docId), data)
                    const nilaiDocRef = doc(db, "nilai", docId); 

                    return setDoc(nilaiDocRef, {
                        nis: nisStr,
                        mapel,
                        asesmen,
                        nilai: Number(n.nilai) || 0,
                        deskripsi: n.deskripsi || "",
                        guru: n.guru || (currentUser?.name || "Guru"),
                        kelas: kelas
                    })
                    .then(() => {
                        console.log(`‚úÖ Nilai ${nisStr} berhasil disimpan`);
                        successCount++;
                    })
                    .catch(error => {
                        console.error(`‚ùå Error simpan nilai ${nisStr}:`, error);
                        errorCount++;
                    });
                });

                // Tunggu hingga semua operasi penyimpanan selesai
                await Promise.all(savePromises);

                alert(`‚úÖ Proses penyimpanan selesai: ${successCount} berhasil, ${errorCount} gagal/dilewati.`);
                
                // Opsional: Muat ulang data nilai dari Firebase setelah penyimpanan selesai
                // await loadNilai();
            }
        </script>


<body class="bg-gray-50 min-h-screen">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-white flex items-center justify-center z-50">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div>
            <p class="text-gray-600">Memuat aplikasi...</p>
        </div>
    </div>

    <!-- Firebase Connection Status -->
    <div id="connectionStatus" class="fixed top-4 right-4 z-40 hidden">
        <div class="bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg">
            ‚ùå Tidak terhubung ke Firebase
        </div>
    </div>

    <!-- Login Page -->
    <div id="loginPage" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100 hidden">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="text-2xl font-bold text-gray-800 mb-2">E-Raport Firebase</h1>
                <h2 class="text-lg text-primary font-semibold">MTS ATTAQWA 18</h2>
                <p class="text-gray-600 text-sm mt-2">Sistem Informasi Raport Digital</p>
                <div class="mt-2 text-xs text-green-600">üî• Powered by Firebase</div>
            </div>
            
            <form id="loginForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                    <input type="text" id="username" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Masukkan username">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Masukkan password">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Login Sebagai</label>
                    <select id="userType" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                        <option value="admin">Admin/Operator</option>
                        <option value="guru">Guru/Wali Kelas</option>
                    </select>
                </div>
                
                <button type="submit" class="w-full bg-primary text-white py-3 rounded-lg hover:bg-blue-700 transition duration-200 font-medium">
                    Masuk
                </button>
            </form>
            
            <div id="loginError" class="mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg hidden">
                Username atau password salah!
            </div>
            
            <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <h4 class="font-semibold text-blue-800 mb-2">Login Demo:</h4>
                <p class="text-sm text-blue-700">Admin: admin / admin</p>
                <p class="text-sm text-blue-700">Guru: ahmad / 123</p>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="hidden">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="px-6 py-4 flex justify-between items-center">
                <div>
                    <h1 class="text-xl font-bold text-gray-800">Dashboard Admin</h1>
                    <p class="text-sm text-gray-600">MTS ATTAQWA 18 - Firebase Version</p>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-xs text-green-600">üî• Online</div>
                    <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition duration-200">
                        Logout
                    </button>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="bg-primary text-white">
            <div class="px-6 py-3">
                <div class="flex space-x-6">
                    <button onclick="showAdminSection('guru')" class="admin-nav-btn px-4 py-2 rounded hover:bg-blue-700 transition duration-200">Data Guru</button>
                    <button onclick="showAdminSection('siswa')" class="admin-nav-btn px-4 py-2 rounded hover:bg-blue-700 transition duration-200">Data Siswa</button>
                    <button onclick="showAdminSection('mapel')" class="admin-nav-btn px-4 py-2 rounded hover:bg-blue-700 transition duration-200">Mata Pelajaran</button>
                    <button onclick="showAdminSection('wali')" class="admin-nav-btn px-4 py-2 rounded hover:bg-blue-700 transition duration-200">Wali Kelas</button>
                </div>
            </div>
        </nav>

        <!-- Content Area -->
        <div class="p-6">
            <!-- Data Guru Section -->
            <div id="adminGuruSection" class="admin-section">
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-semibold text-gray-800">Manajemen Data Guru</h2>
                        <button onclick="showAddGuruForm()" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                            + Tambah Guru
                        </button>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-300">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="border border-gray-300 px-4 py-3 text-left">ID</th>
                                    <th class="border border-gray-300 px-4 py-3 text-left">Nama</th>
                                    <th class="border border-gray-300 px-4 py-3 text-left">Jabatan</th>
                                    <th class="border border-gray-300 px-4 py-3 text-left">Mata Pelajaran</th>
                                    <th class="border border-gray-300 px-4 py-3 text-left">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="guruTableBody">
                                <tr>
                                    <td colspan="5" class="border border-gray-300 px-4 py-8 text-center text-gray-500">
                                        Memuat data guru...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Data Siswa Section -->
            <div id="adminSiswaSection" class="admin-section hidden">
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-semibold text-gray-800">Manajemen Data Siswa</h2>
                        <div class="flex space-x-3">
                            <button onclick="showUploadSiswaForm()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition duration-200">
                                üìÅ Upload File Excel
                            </button>
                            <button onclick="showAddSiswaForm()" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                                + Tambah Siswa
                            </button>
                        </div>
                    </div>

                    <div class="mb-4 flex space-x-4 items-center">
                        <select id="kelasFilter" onchange="filterSiswaByKelas()" class="px-4 py-2 border border-gray-300 rounded-lg">
                            <option value="">Semua Kelas</option>
                            <option value="VII A">VII A</option>
                            <option value="VII B">VII B</option>
                            <option value="VIII A">VIII A</option>
                            <option value="VIII B">VIII B</option>
                            <option value="IX A">IX A</option>
                            <option value="IX B">IX B</option>
                        </select>

                        <select id="sortAbjadFilter" onchange="sortSiswaByAbjad()" class="px-4 py-2 border border-gray-300 rounded-lg">
                            <option value="default">Urutkan Nama (Default)</option>
                            <option value="asc">Nama (A-Z)</option>
                            <option value="desc">Nama (Z-A)</option>
                        </select>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-300">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="border border-gray-300 px-4 py-3 text-left">NIS</th>
                                    
                                    <th 
                                        class="border border-gray-300 px-4 py-3 text-left cursor-pointer hover:bg-gray-100"
                                        onclick="sortSiswaTable('nama')"
                                        id="headerNama"
                                    >
                                        Nama <span id="sortIcon"></span>
                                    </th>
                                    <th class="border border-gray-300 px-4 py-3 text-left">Kelas</th>
                                    <th class="border border-gray-300 px-4 py-3 text-left">Wali Kelas</th>
                                    <th class="border border-gray-300 px-4 py-3 text-left">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="siswaTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Mata Pelajaran Section -->
            <div id="adminMapelSection" class="admin-section hidden">
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-6">Manajemen Mata Pelajaran</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div id="mapelList" class="space-y-3">
                            <div class="text-center text-gray-500 py-8">Memuat mata pelajaran...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Wali Kelas Section -->
            <div id="adminWaliSection" class="admin-section hidden">
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-6">Penetapan Wali Kelas</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="border border-gray-300 rounded-lg p-4">
                            <h3 class="font-semibold mb-3">VII A</h3>
                            <select id="waliVIIA" onchange="setWaliKelas('VII A', this.value)" class="w-full px-3 py-2 border border-gray-300 rounded">
                                <option value="">Memuat...</option>
                            </select>
                        </div>
                        <div class="border border-gray-300 rounded-lg p-4">
                            <h3 class="font-semibold mb-3">VII B</h3>
                            <select id="waliVIIB" onchange="setWaliKelas('VII B', this.value)" class="w-full px-3 py-2 border border-gray-300 rounded">
                                <option value="">Memuat...</option>
                            </select>
                        </div>
                        <div class="border border-gray-300 rounded-lg p-4">
                            <h3 class="font-semibold mb-3">VIII A</h3>
                            <select id="waliVIIIA" onchange="setWaliKelas('VIII A', this.value)" class="w-full px-3 py-2 border border-gray-300 rounded">
                                <option value="">Memuat...</option>
                            </select>
                        </div>
                        <div class="border border-gray-300 rounded-lg p-4">
                            <h3 class="font-semibold mb-3">VIII B</h3>
                            <select id="waliVIIIB" onchange="setWaliKelas('VIII B', this.value)" class="w-full px-3 py-2 border border-gray-300 rounded">
                                <option value="">Memuat...</option>
                            </select>
                        </div>
                        <div class="border border-gray-300 rounded-lg p-4">
                            <h3 class="font-semibold mb-3">IX A</h3>
                            <select id="waliIXA" onchange="setWaliKelas('IX A', this.value)" class="w-full px-3 py-2 border border-gray-300 rounded">
                                <option value="">Memuat...</option>
                            </select>
                        </div>
                        <div class="border border-gray-300 rounded-lg p-4">
                            <h3 class="font-semibold mb-3">IX B</h3>
                            <select id="waliIXB" onchange="setWaliKelas('IX B', this.value)" class="w-full px-3 py-2 border border-gray-300 rounded">
                                <option value="">Memuat...</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Guru Dashboard -->
    <div id="guruDashboard" class="hidden">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="px-6 py-4 flex justify-between items-center">
                <div>
                    <h1 class="text-xl font-bold text-gray-800">Dashboard Guru</h1>
                    <p class="text-sm text-gray-600" id="guruName">Selamat datang, Guru</p>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-xs text-green-600">üî• Online</div>
                    <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition duration-200">
                        Logout
                    </button>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="bg-primary text-white">
            <div class="px-6 py-3">
                <div class="flex space-x-6">
                    <button onclick="showGuruSection('input')" class="guru-nav-btn px-4 py-2 rounded hover:bg-blue-700 transition duration-200">Input Nilai</button>
                    <button onclick="showGuruSection('cetak')" class="guru-nav-btn px-4 py-2 rounded hover:bg-blue-700 transition duration-200">Cetak Raport</button>
                </div>
            </div>
        </nav>

        <!-- Input Nilai Section -->
        <div id="guruInputSection" class="guru-section">
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-6">Input Nilai Siswa</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran</label>
                        <select id="mapelSelect" onchange="loadSiswaForNilai()" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            <option value="">Pilih Mata Pelajaran</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                        <select id="kelasSelect" onchange="loadSiswaForNilai()" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            <option value="">Pilih Kelas</option>
                            <option value="VII A">VII A</option>
                            <option value="VII B">VII B</option>
                            <option value="VIII A">VIII A</option>
                            <option value="VIII B">VIII B</option>
                            <option value="IX A">IX A</option>
                            <option value="IX B">IX B</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Jenis Asesmen</label>
                        <select id="asesmenSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            <option value="ASTS">ASTS (Tengah Semester)</option>
                            <option value="ASAS">ASAS (Akhir Semester)</option>
                        </select>
                    </div>
                </div>

                <!-- üîπ Tombol Download & Upload Excel -->
                <div class="mb-6 flex space-x-4">
                    <button onclick="downloadTemplateNilai()" 
                        class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition duration-200">
                        üìÑ Download Template Excel
                    </button>

                    <input type="file" id="uploadNilaiFile" accept=".xlsx,.xls" 
                        class="border border-gray-300 rounded-lg px-3 py-2">

                    <button onclick="uploadNilaiExcel()" 
                        class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition duration-200">
                        ‚¨ÜÔ∏è Upload Nilai Excel
                    </button>
                </div>
                
                <div id="nilaiInputArea" class="hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-300">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="border border-gray-300 px-4 py-3 text-left">No</th>
                                    <th class="border border-gray-300 px-4 py-3 text-left">NIS</th>
                                    <th class="border border-gray-300 px-4 py-3 text-left">Nama Siswa</th>
                                    <th class="border border-gray-300 px-4 py-3 text-left">Nilai</th>
                                    <th class="border border-gray-300 px-4 py-3 text-left">Deskripsi</th>
                                </tr>
                            </thead>
                            <tbody id="nilaiTableBody">
                                <!-- Data siswa untuk input nilai akan dimuat di sini -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-6 flex justify-end">
                        <button onclick="simpanNilai()" class="bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600 transition duration-200">
                            üíæ Simpan ke Firebase
                        </button>
                    </div>
                </div>
            </div>
        </div>


            <!-- Cetak Raport Section -->
            <div id="guruCetakSection" class="guru-section hidden">
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-6">Cetak Raport Siswa</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                            <select id="cetakKelasSelect" onchange="loadSiswaForCetak()" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                <option value="">Pilih Kelas</option>
                                <option value="VII A">VII A</option>
                                <option value="VII B">VII B</option>
                                <option value="VIII A">VIII A</option>
                                <option value="VIII B">VIII B</option>
                                <option value="IX A">IX A</option>
                                <option value="IX B">IX B</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Siswa</label>
                            <select id="cetakSiswaSelect" onchange="previewRaport()" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                <option value="">Pilih Siswa</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <h4 class="font-semibold text-blue-800 mb-2">Debug Info:</h4>
                        <div class="text-sm text-blue-700">
                            <p>Total Siswa: <span id="debugSiswaCount">0</span></p>
                            <p>Total Nilai: <span id="debugNilaiCount">0</span></p>
                            <button onclick="debugShowData()" class="mt-2 bg-blue-500 text-white px-3 py-1 rounded text-xs hover:bg-blue-600">
                                Show Data in Console
                            </button>
                        </div>
                    </div>
                    
                    <div id="raportPreview" class="hidden">
                        <!-- Preview raport akan ditampilkan di sini -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Forms -->
    <!-- Add Guru Modal -->
    <div id="addGuruModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4 max-h-screen overflow-y-auto">
            <h3 class="text-lg font-semibold mb-4">Tambah Data Guru</h3>
            <form id="addGuruForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap</label>
                    <input type="text" id="guruNama" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Jabatan</label>
                    <select id="guruJabatan" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                        <option value="">Pilih Jabatan</option>
                        <option value="Guru Mata Pelajaran">Guru Mata Pelajaran</option>
                        <option value="Wali Kelas">Wali Kelas</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                    <input type="text" id="guruUsername" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="guruPassword" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran (Pilih beberapa)</label>
                    <div id="mapelCheckboxes" class="space-y-2 max-h-40 overflow-y-auto border border-gray-300 rounded-lg p-3">
                        <!-- Checkboxes akan dimuat di sini -->
                    </div>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="closeAddGuruModal()" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">
                        Batal
                    </button>
                    <button type="submit" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-700">
                        üíæ Simpan ke Firebase
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Siswa Modal -->
    <div id="addSiswaModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <h3 class="text-lg font-semibold mb-4">Tambah Data Siswa</h3>
            <form id="addSiswaForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">NIS</label>
                    <input type="text" id="siswaNIS" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap</label>
                    <input type="text" id="siswaNama" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Kelas</label>
                    <select id="siswaKelas" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                        <option value="">Pilih Kelas</option>
                        <option value="VII A">VII A</option>
                        <option value="VII B">VII B</option>
                        <option value="VIII A">VIII A</option>
                        <option value="VIII B">VIII B</option>
                        <option value="IX A">IX A</option>
                        <option value="IX B">IX B</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">NISN</label>
                    <input type="text" id="siswaNISN" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tempat, Tanggal Lahir</label>
                    <input type="text" id="siswaTTL" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Contoh: Jakarta, 15 Januari 2008">
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="closeAddSiswaModal()" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">
                        Batal
                    </button>
                    <button type="submit" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-700">
                        üíæ Simpan ke Firebase
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Upload Siswa Modal -->
    <div id="uploadSiswaModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-lg mx-4">
            <h3 class="text-lg font-semibold mb-4">Upload Data Siswa dari File Excel</h3>
            
            <div class="mb-6">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                    <h4 class="font-semibold text-blue-800 mb-2">Format File Excel:</h4>
                    <p class="text-sm text-blue-700 mb-2">File harus memiliki kolom dengan urutan:</p>
                    <ol class="text-sm text-blue-700 list-decimal list-inside space-y-1">
                        <li>NIS</li>
                        <li>Nama Lengkap</li>
                        <li>Kelas (VII A, VII B, VIII A, dll)</li>
                        <li>NISN</li>
                        <li>Tempat, Tanggal Lahir</li>
                    </ol>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Pilih File Excel (.xlsx, .xls)</label>
                    <input type="file" id="fileUpload" accept=".xlsx,.xls" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                </div>
            </div>
            
            <div id="uploadPreview" class="hidden mb-4">
                <h4 class="font-semibold mb-2">Preview Data:</h4>
                <div class="max-h-40 overflow-y-auto border border-gray-300 rounded-lg">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-2 py-1 border-b">NIS</th>
                                <th class="px-2 py-1 border-b">Nama</th>
                                <th class="px-2 py-1 border-b">Kelas</th>
                                <th class="px-2 py-1 border-b">NISN</th>
                                <th class="px-2 py-1 border-b">TTL</th>
                            </tr>
                        </thead>
                        <tbody id="previewTableBody">
                        </tbody>
                    </table>
                </div>
                <p class="text-sm text-gray-600 mt-2">Total: <span id="totalRows">0</span> siswa</p>
            </div>
            
            <div class="flex justify-end space-x-3">
                <button type="button" onclick="closeUploadSiswaModal()" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">
                    Batal
                </button>
                <button onclick="processUpload()" id="uploadBtn" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 disabled:bg-gray-400" disabled>
                    üìÅ Upload ke Firebase
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let dataGuru = [];
        let dataSiswa = [];
        let dataNilai = [];
        let dataWaliKelas = {};
        let isFirebaseReady = false;
        let uploadedData = [];
        
        const dataMapel = [
            "AKIDAH AKHLAK", "AL-QURAN HADIS", "FIQIH", "SEJARAH KEBUDAYAAN ISLAM", "BAHASA INDONESIA", 
            "BAHASA ARAB", "BAHASA INGGRIS", "MATEMATIKA", "PENDIDIKAN KEWARGANEGARAAN", "ILMU PENGETAHUAN ALAM",
            "ILMU PENGETAHUAN SOSIAL", "PENDIDIKAN OLAHRAGA DAN JASMANI", "SENI BUDAYA", 
            "TAHSIN AL-QUR'AN", "PRAKARYA"
        ];

        // Initialize app
        async function initializeAppFirebase() {
            try {
                // Test Firebase connection
                await testFirebaseConnection();
                isFirebaseReady = true;
                
                // Initialize default data if needed
                await initializeDefaultData();
                
                // Hide loading screen and show login
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('loginPage').classList.remove('hidden');
                
                console.log('‚úÖ Firebase connected successfully!');
            } catch (error) {
                console.error('‚ùå Firebase connection failed:', error);
                // Try offline mode instead of showing error
                initializeOfflineMode();
            }
        }

        // Offline mode for testing
        function initializeOfflineMode() {
            console.log('üîÑ Starting in offline mode...');
            isFirebaseReady = false;
            
            // Initialize with demo data
            initializeDemoData();
            
            // Hide loading screen and show login
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('loginPage').classList.remove('hidden');
            
            // Show offline indicator
            const offlineIndicator = document.createElement('div');
            offlineIndicator.className = 'fixed top-4 right-4 z-40 bg-yellow-500 text-white px-4 py-2 rounded-lg shadow-lg';
            offlineIndicator.innerHTML = '‚ö†Ô∏è Mode Offline - Data Demo';
            document.body.appendChild(offlineIndicator);
        }

        // Initialize demo data for offline mode
        function initializeDemoData() {
            dataGuru = [
                {id: '1', nama: "Ahmad Fauzi", jabatan: "Guru Mata Pelajaran", username: "ahmad", password: "123", mapel: ["AKIDAH AKHLAK", "FIQIH"]},
                {id: '2', nama: "Siti Nurhaliza", jabatan: "Wali Kelas", username: "siti", password: "123", mapel: ["BAHASA INDONESIA", "SENI BUDAYA"]},
                {id: '3', nama: "Muhammad Rizki", jabatan: "Guru Mata Pelajaran", username: "rizki", password: "123", mapel: ["MATEMATIKA", "ILMU PENGETAHUAN ALAM"]}
            ];
            
            dataSiswa = [
                {id: '1', nis: "2024001", nama: "Abdullah Rahman", kelas: "VII A", nisn: "1234567890", ttl: "Jakarta, 15 Januari 2010", waliKelas: "Siti Nurhaliza"},
                {id: '2', nis: "2024002", nama: "Fatimah Zahra", kelas: "VII A", nisn: "1234567891", ttl: "Bogor, 20 Februari 2010", waliKelas: "Siti Nurhaliza"},
                {id: '3', nis: "2024003", nama: "Muhammad Iqbal", kelas: "VII B", nisn: "1234567892", ttl: "Depok, 10 Maret 2010", waliKelas: ""},
                {id: '4', nis: "2024004", nama: "Aisyah Putri", kelas: "VIII A", nisn: "1234567893", ttl: "Tangerang, 5 April 2009", waliKelas: ""}
            ];
            
            dataNilai = [
                {id: '1', nis: "2024001", mapel: "AKIDAH AKHLAK", asesmen: "ASTS", nilai: 85, deskripsi: "Baik", guru: "Ahmad Fauzi"},
                {id: '2', nis: "2024001", mapel: "AKIDAH AKHLAK", asesmen: "ASAS", nilai: 88, deskripsi: "Sangat Baik", guru: "Ahmad Fauzi"},
                {id: '3', nis: "2024002", mapel: "BAHASA INDONESIA", asesmen: "ASTS", nilai: 90, deskripsi: "Sangat Baik", guru: "Siti Nurhaliza"}
            ];
        }

        async function testFirebaseConnection() {
            try {
                // Try to read from Firestore
                const testQuery = query(collection(db, 'guru'));
                await getDocs(testQuery);
                return true;
            } catch (error) {
                throw new Error('Firebase connection failed: ' + error.message);
            }
        }

        // Initialize default data
        async function initializeDefaultData() {
            try {
                // Check if admin user exists
                const adminQuery = query(collection(db, 'users'), where('username', '==', 'admin'));
                const adminSnapshot = await getDocs(adminQuery);
                
                if (adminSnapshot.empty) {
                    // Create default admin
                    await addDoc(collection(db, 'users'), {
                        username: 'admin',
                        password: 'admin',
                        type: 'admin',
                        nama: 'Administrator'
                    });
                }
                
                // Check if default guru exists
                const guruQuery = query(collection(db, 'guru'));
                const guruSnapshot = await getDocs(guruQuery);
                
                if (guruSnapshot.empty) {
                    // Create default guru with multiple mapel
                    const defaultGuru = [
                        {nama: "Ahmad Fauzi", jabatan: "Guru Mata Pelajaran", username: "ahmad", password: "123", mapel: ["AKIDAH AKHLAK", "FIQIH"]},
                        {nama: "Siti Nurhaliza", jabatan: "Wali Kelas", username: "siti", password: "123", mapel: ["BAHASA INDONESIA", "SENI BUDAYA"]},
                        {nama: "Muhammad Rizki", jabatan: "Guru Mata Pelajaran", username: "rizki", password: "123", mapel: ["MATEMATIKA", "ILMU PENGETAHUAN ALAM"]}
                    ];
                    
                    for (const guru of defaultGuru) {
                        await addDoc(collection(db, 'guru'), guru);
                        // Also create user account for guru
                        await addDoc(collection(db, 'users'), {
                            username: guru.username,
                            password: guru.password,
                            type: 'guru',
                            nama: guru.nama
                        });
                    }
                }
                
                // Check if default siswa exists
                const siswaQuery = query(collection(db, 'siswa'));
                const siswaSnapshot = await getDocs(siswaQuery);
                
                if (siswaSnapshot.empty) {
                    // Create default siswa
                    const defaultSiswa = [
                        {nis: "2024001", nama: "Abdullah Rahman", kelas: "VII A", nisn: "1234567890", ttl: "Jakarta, 15 Januari 2010", waliKelas: ""},
                        {nis: "2024002", nama: "Fatimah Zahra", kelas: "VII A", nisn: "1234567891", ttl: "Bogor, 20 Februari 2010", waliKelas: ""},
                        {nis: "2024003", nama: "Muhammad Iqbal", kelas: "VII B", nisn: "1234567892", ttl: "Depok, 10 Maret 2010", waliKelas: ""},
                        {nis: "2024004", nama: "Aisyah Putri", kelas: "VIII A", nisn: "1234567893", ttl: "Tangerang, 5 April 2009", waliKelas: ""}
                    ];
                    
                    for (const siswa of defaultSiswa) {
                        await addDoc(collection(db, 'siswa'), siswa);
                    }
                }
                
                console.log('‚úÖ Default data initialized');
            } catch (error) {
                console.error('‚ùå Error initializing default data:', error);
            }
        }

        // Firebase CRUD Operations
        async function loadDataFromFirebase() {
            try {
                // Load guru data
                const guruQuery = query(collection(db, 'guru'));
                const guruSnapshot = await getDocs(guruQuery);
                dataGuru = [];
                guruSnapshot.forEach((doc) => {
                    dataGuru.push({ id: doc.id, ...doc.data() });
                });
                
                // Load siswa data
                const siswaQuery = query(collection(db, 'siswa'));
                const siswaSnapshot = await getDocs(siswaQuery);
                dataSiswa = [];
                siswaSnapshot.forEach((doc) => {
                    dataSiswa.push({ id: doc.id, ...doc.data() });
                });
                
                // Load nilai data
                const nilaiQuery = query(collection(db, 'nilai'));
                const nilaiSnapshot = await getDocs(nilaiQuery);
                dataNilai = [];
                nilaiSnapshot.forEach((doc) => {
                    dataNilai.push({ id: doc.id, ...doc.data() });
                });
                
                console.log('‚úÖ Data loaded from Firebase');
            } catch (error) {
                console.error('‚ùå Error loading data from Firebase:', error);
                alert('Gagal memuat data dari Firebase: ' + error.message);
            }
        }

        // Login functionality
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const userType = document.getElementById('userType').value;
            
            try {
                let loginSuccess = false;
                
                if (isFirebaseReady) {
                    // Firebase login
                    const userQuery = query(
                        collection(db, 'users'), 
                        where('username', '==', username),
                        where('password', '==', password),
                        where('type', '==', userType)
                    );
                    const userSnapshot = await getDocs(userQuery);
                    
                    if (!userSnapshot.empty) {
                        const userData = userSnapshot.docs[0].data();
                        currentUser = {
                            type: userData.type,
                            name: userData.nama,
                            username: userData.username
                        };
                        
                        // Load additional data for guru
                        if (userType === 'guru') {
                            const guruQuery = query(collection(db, 'guru'), where('username', '==', username));
                            const guruSnapshot = await getDocs(guruQuery);
                            if (!guruSnapshot.empty) {
                                currentUser.data = { id: guruSnapshot.docs[0].id, ...guruSnapshot.docs[0].data() };
                            }
                        }
                        
                        loginSuccess = true;
                    }
                } else {
                    // Offline login
                    if ((username === 'admin' && password === 'admin' && userType === 'admin') ||
                        (username === 'ahmad' && password === '123' && userType === 'guru') ||
                        (username === 'siti' && password === '123' && userType === 'guru') ||
                        (username === 'rizki' && password === '123' && userType === 'guru')) {
                        
                        if (userType === 'admin') {
                            currentUser = {
                                type: 'admin',
                                name: 'Administrator',
                                username: 'admin'
                            };
                        } else {
                            const guru = dataGuru.find(g => g.username === username);
                            currentUser = {
                                type: 'guru',
                                name: guru.nama,
                                username: guru.username,
                                data: guru
                            };
                        }
                        
                        loginSuccess = true;
                    }
                }
                
                if (loginSuccess) {
                    await showDashboard(userType);
                } else {
                    // Login failed
                    document.getElementById('loginError').classList.remove('hidden');
                    setTimeout(() => {
                        document.getElementById('loginError').classList.add('hidden');
                    }, 3000);
                }
            } catch (error) {
                console.error('‚ùå Login error:', error);
                alert('Error saat login: ' + error.message);
            }
        });

        async function showDashboard(type) {
            document.getElementById('loginPage').classList.add('hidden');
            
            // Load data from Firebase only if connected
            if (isFirebaseReady) {
                await loadDataFromFirebase();
            }
            
            if (type === 'admin') {
                document.getElementById('adminDashboard').classList.remove('hidden');
                loadAdminData();
                showAdminSection('guru');
            } else {
                document.getElementById('guruDashboard').classList.remove('hidden');
                document.getElementById('guruName').textContent = `Selamat datang, ${currentUser.name}`;
                loadGuruData();
                showGuruSection('input');
            }
        }

        function logout() {
            currentUser = null;
            document.getElementById('adminDashboard').classList.add('hidden');
            document.getElementById('guruDashboard').classList.add('hidden');
            document.getElementById('loginPage').classList.remove('hidden');
            
            // Reset form
            document.getElementById('loginForm').reset();
        }

        // Admin Functions
        function showAdminSection(section) {
            // Hide all sections
            document.querySelectorAll('.admin-section').forEach(s => s.classList.add('hidden'));
            
            // Show selected section
            document.getElementById(`admin${section.charAt(0).toUpperCase() + section.slice(1)}Section`).classList.remove('hidden');
            
            // Update navigation
            document.querySelectorAll('.admin-nav-btn').forEach(btn => btn.classList.remove('bg-blue-700'));
            event.target.classList.add('bg-blue-700');
        }

        function loadAdminData() {
            loadGuruTable();
            loadSiswaTable();
            loadMapelList();
            loadWaliKelasOptions();
        }

        function loadGuruTable() {
            const tbody = document.getElementById('guruTableBody');
            tbody.innerHTML = '';
            
            if (dataGuru.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="border border-gray-300 px-4 py-8 text-center text-gray-500">Tidak ada data guru</td></tr>';
                return;
            }
            
            dataGuru.forEach((guru, index) => {
                const row = document.createElement('tr');
                const mapelList = Array.isArray(guru.mapel) ? guru.mapel.join(', ') : guru.mapel;
                row.innerHTML = `
                    <td class="border border-gray-300 px-4 py-2">${index + 1}</td>
                    <td class="border border-gray-300 px-4 py-2">${guru.nama}</td>
                    <td class="border border-gray-300 px-4 py-2">${guru.jabatan}</td>
                    <td class="border border-gray-300 px-4 py-2 text-sm">${mapelList}</td>
                    <td class="border border-gray-300 px-4 py-2">
                        <button onclick="editGuru('${guru.id}')" class="bg-yellow-500 text-white px-2 py-1 rounded text-sm hover:bg-yellow-600 mr-2">Edit</button>
                        <button onclick="deleteGuru('${guru.id}')" class="bg-red-500 text-white px-2 py-1 rounded text-sm hover:bg-red-600">Hapus</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function loadSiswaTable() {
            const tbody = document.getElementById('siswaTableBody');
            tbody.innerHTML = '';
            
            let filteredSiswa = dataSiswa;
            const kelasFilter = document.getElementById('kelasFilter').value;
            if (kelasFilter) {
                filteredSiswa = dataSiswa.filter(siswa => siswa.kelas === kelasFilter);
            }
            
            if (filteredSiswa.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="border border-gray-300 px-4 py-8 text-center text-gray-500">Tidak ada data siswa</td></tr>';
                return;
            }
            
            filteredSiswa.forEach(siswa => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="border border-gray-300 px-4 py-2">${siswa.nis}</td>
                    <td class="border border-gray-300 px-4 py-2">${siswa.nama}</td>
                    <td class="border border-gray-300 px-4 py-2">${siswa.kelas}</td>
                    <td class="border border-gray-300 px-4 py-2">${siswa.waliKelas || '-'}</td>
                    <td class="border border-gray-300 px-4 py-2">
                        <button onclick="editSiswa('${siswa.id}')" class="bg-yellow-500 text-white px-2 py-1 rounded text-sm hover:bg-yellow-600 mr-2">Edit</button>
                        <button onclick="deleteSiswa('${siswa.id}')" class="bg-red-500 text-white px-2 py-1 rounded text-sm hover:bg-red-600">Hapus</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function loadMapelList() {
            const container = document.getElementById('mapelList');
            container.innerHTML = '';
            
            dataMapel.forEach(mapel => {
                const guruList = dataGuru.filter(g => Array.isArray(g.mapel) ? g.mapel.includes(mapel) : g.mapel === mapel);
                const div = document.createElement('div');
                div.className = 'border border-gray-300 rounded-lg p-4';
                div.innerHTML = `
                    <h3 class="font-semibold mb-2">${mapel}</h3>
                    <p class="text-sm text-gray-600 mb-2">Guru: ${guruList.length > 0 ? guruList.map(g => g.nama).join(', ') : 'Belum ditentukan'}</p>
                    <select onchange="assignGuru('${mapel}', this.value)" class="w-full mt-2 px-2 py-1 border border-gray-300 rounded text-sm">
                        <option value="">Pilih Guru</option>
                        ${dataGuru.map(g => `<option value="${g.id}">${g.nama}</option>`).join('')}
                    </select>
                `;
                container.appendChild(div);
            });
        }

        function loadWaliKelasOptions() {
            const selects = ['waliVIIA', 'waliVIIB', 'waliVIIIA', 'waliVIIIB', 'waliIXA', 'waliIXB'];
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">Pilih Wali Kelas</option>';
                
                dataGuru.forEach(guru => {
                    const option = document.createElement('option');
                    option.value = guru.id;
                    option.textContent = guru.nama;
                    select.appendChild(option);
                });
            });
        }

        function filterSiswaByKelas() {
            loadSiswaTable();
        }

        async function assignGuru(mapel, guruId) {
            if (guruId) {
                try {
                    const guru = dataGuru.find(g => g.id === guruId);
                    if (guru) {
                        // Update guru mapel array
                        let updatedMapel = Array.isArray(guru.mapel) ? [...guru.mapel] : [guru.mapel];
                        if (!updatedMapel.includes(mapel)) {
                            updatedMapel.push(mapel);
                        }
                        
                        if (isFirebaseReady) {
                            await updateDoc(doc(db, 'guru', guruId), {
                                mapel: updatedMapel
                            });
                        }
                        
                        // Update local data
                        guru.mapel = updatedMapel;
                        loadMapelList();
                        loadGuruTable();
                        
                        alert('‚úÖ Mata pelajaran berhasil ditetapkan!');
                    }
                } catch (error) {
                    console.error('‚ùå Error assigning guru:', error);
                    alert('Gagal menetapkan mata pelajaran: ' + error.message);
                }
            }
        }

        async function setWaliKelas(kelas, guruId) {
            if (guruId) {
                try {
                    const guru = dataGuru.find(g => g.id === guruId);
                    if (guru) {
                        // Update all siswa in this class
                        const siswaInClass = dataSiswa.filter(s => s.kelas === kelas);
                        
                        for (const siswa of siswaInClass) {
                            if (isFirebaseReady) {
                                await updateDoc(doc(db, 'siswa', siswa.id), {
                                    waliKelas: guru.nama
                                });
                            }
                            siswa.waliKelas = guru.nama;
                        }
                        
                        loadSiswaTable();
                        alert(`‚úÖ Wali kelas ${kelas} berhasil ditetapkan!`);
                    }
                } catch (error) {
                    console.error('‚ùå Error setting wali kelas:', error);
                    alert('Gagal menetapkan wali kelas: ' + error.message);
                }
            }
        }

        // Modal Functions
        function showAddGuruForm() {
            // Load mapel checkboxes
            const container = document.getElementById('mapelCheckboxes');
            container.innerHTML = '';
            
            dataMapel.forEach(mapel => {
                const div = document.createElement('div');
                div.className = 'flex items-center';
                div.innerHTML = `
                    <input type="checkbox" id="mapel_${mapel}" value="${mapel}" class="mr-2">
                    <label for="mapel_${mapel}" class="text-sm">${mapel}</label>
                `;
                container.appendChild(div);
            });
            
            document.getElementById('addGuruModal').classList.remove('hidden');
            document.getElementById('addGuruModal').classList.add('flex');
        }

        function closeAddGuruModal() {
            document.getElementById('addGuruModal').classList.add('hidden');
            document.getElementById('addGuruModal').classList.remove('flex');
            document.getElementById('addGuruForm').reset();
            
            // Reset form to add mode
            const form = document.getElementById('addGuruForm');
            form.removeAttribute('data-edit-id');
            
            // Reset button text and modal title
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.innerHTML = 'üíæ Simpan ke Firebase';
            document.querySelector('#addGuruModal h3').textContent = 'Tambah Data Guru';
            
            // Uncheck all mapel checkboxes
            document.querySelectorAll('#mapelCheckboxes input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
        }

        function showAddSiswaForm() {
            document.getElementById('addSiswaModal').classList.remove('hidden');
            document.getElementById('addSiswaModal').classList.add('flex');
        }

        function closeAddSiswaModal() {
            document.getElementById('addSiswaModal').classList.add('hidden');
            document.getElementById('addSiswaModal').classList.remove('flex');
            document.getElementById('addSiswaForm').reset();
            
            // Reset form to add mode
            const form = document.getElementById('addSiswaForm');
            form.removeAttribute('data-edit-id');
            
            // Reset button text and modal title
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.innerHTML = 'üíæ Simpan ke Firebase';
            document.querySelector('#addSiswaModal h3').textContent = 'Tambah Data Siswa';
        }

        function showUploadSiswaForm() {
            document.getElementById('uploadSiswaModal').classList.remove('hidden');
            document.getElementById('uploadSiswaModal').classList.add('flex');
        }

        function closeUploadSiswaModal() {
            document.getElementById('uploadSiswaModal').classList.add('hidden');
            document.getElementById('uploadSiswaModal').classList.remove('flex');
            document.getElementById('fileUpload').value = '';
            document.getElementById('uploadPreview').classList.add('hidden');
            uploadedData = [];
        }

        // File Upload Functions
        document.getElementById('fileUpload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                        
                        // Skip header row and process data
                        uploadedData = [];
                        for (let i = 1; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            if (row[0] && row[1]) { // At least NIS and Nama must exist
                                uploadedData.push({
                                    nis: row[0].toString(),
                                    nama: row[1],
                                    kelas: row[2] || '',
                                    nisn: row[3] ? row[3].toString() : '',
                                    ttl: row[4] || '',
                                    waliKelas: ''
                                });
                            }
                        }
                        
                        showUploadPreview();
                    } catch (error) {
                        alert('Error membaca file: ' + error.message);
                    }
                };
                reader.readAsArrayBuffer(file);
            }
        });

        function showUploadPreview() {
            const tbody = document.getElementById('previewTableBody');
            tbody.innerHTML = '';
            
            uploadedData.forEach(siswa => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-2 py-1 border-b">${siswa.nis}</td>
                    <td class="px-2 py-1 border-b">${siswa.nama}</td>
                    <td class="px-2 py-1 border-b">${siswa.kelas}</td>
                    <td class="px-2 py-1 border-b">${siswa.nisn}</td>
                    <td class="px-2 py-1 border-b">${siswa.ttl}</td>
                `;
                tbody.appendChild(row);
            });
            
            document.getElementById('totalRows').textContent = uploadedData.length;
            document.getElementById('uploadPreview').classList.remove('hidden');
            document.getElementById('uploadBtn').disabled = uploadedData.length === 0;
        }

        async function processUpload() {
            if (uploadedData.length === 0) {
                alert('Tidak ada data untuk diupload!');
                return;
            }
            
            try {
                let berhasilUpload = 0;
                
                for (const siswa of uploadedData) {
                    // Check if NIS already exists
                    const existingSiswa = dataSiswa.find(s => s.nis === siswa.nis);
                    if (!existingSiswa) {
                        if (isFirebaseReady) {
                            const docRef = await addDoc(collection(db, 'siswa'), siswa);
                            dataSiswa.push({ id: docRef.id, ...siswa });
                        } else {
                            siswa.id = Date.now().toString() + Math.random().toString(36).substr(2, 9);
                            dataSiswa.push(siswa);
                        }
                        berhasilUpload++;
                    }
                }
                
                loadSiswaTable();
                closeUploadSiswaModal();
                
                alert(`‚úÖ Berhasil mengupload ${berhasilUpload} siswa dari ${uploadedData.length} data!`);
            } catch (error) {
                console.error('‚ùå Error uploading data:', error);
                alert('Gagal mengupload data: ' + error.message);
            }
        }

        // Form Submissions
        document.getElementById('addGuruForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                // Get selected mapel
                const selectedMapel = [];
                document.querySelectorAll('#mapelCheckboxes input[type="checkbox"]:checked').forEach(checkbox => {
                    selectedMapel.push(checkbox.value);
                });
                
                if (selectedMapel.length === 0) {
                    alert('Pilih minimal satu mata pelajaran!');
                    return;
                }
                
                const guruData = {
                    nama: document.getElementById('guruNama').value,
                    jabatan: document.getElementById('guruJabatan').value,
                    username: document.getElementById('guruUsername').value,
                    password: document.getElementById('guruPassword').value,
                    mapel: selectedMapel
                };
                
                const editId = this.getAttribute('data-edit-id');
                
                if (editId) {
                    // Edit mode - update existing guru
                    if (isFirebaseReady) {
                        await updateDoc(doc(db, 'guru', editId), guruData);
                        
                        // Update user account too
                        const userQuery = query(collection(db, 'users'), where('username', '==', guruData.username));
                        const userSnapshot = await getDocs(userQuery);
                        if (!userSnapshot.empty) {
                            await updateDoc(userSnapshot.docs[0].ref, {
                                password: guruData.password,
                                nama: guruData.nama
                            });
                        }
                    }
                    
                    // Update local data
                    const guruIndex = dataGuru.findIndex(g => g.id === editId);
                    if (guruIndex !== -1) {
                        dataGuru[guruIndex] = { id: editId, ...guruData };
                    }
                    
                    alert('‚úÖ Data guru berhasil diupdate!');
                } else {
                    // Add mode - create new guru
                    if (isFirebaseReady) {
                        // Add to Firebase
                        const docRef = await addDoc(collection(db, 'guru'), guruData);
                        
                        // Also create user account
                        await addDoc(collection(db, 'users'), {
                            username: guruData.username,
                            password: guruData.password,
                            type: 'guru',
                            nama: guruData.nama
                        });
                        
                        // Update local data
                        dataGuru.push({ id: docRef.id, ...guruData });
                    } else {
                        // Offline mode
                        guruData.id = Date.now().toString();
                        dataGuru.push(guruData);
                    }
                    
                    alert('‚úÖ Data guru berhasil disimpan!');
                }
                
                loadGuruTable();
                loadMapelList();
                loadWaliKelasOptions();
                closeAddGuruModal();
                
            } catch (error) {
                console.error('‚ùå Error saving guru:', error);
                alert('Gagal menyimpan data guru: ' + error.message);
            }
        });

        document.getElementById('addSiswaForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                const siswaData = {
                    nis: document.getElementById('siswaNIS').value,
                    nama: document.getElementById('siswaNama').value,
                    kelas: document.getElementById('siswaKelas').value,
                    nisn: document.getElementById('siswaNISN').value,
                    ttl: document.getElementById('siswaTTL').value,
                    waliKelas: ''
                };
                
                const editId = this.getAttribute('data-edit-id');
                
                if (editId) {
                    // Edit mode - update existing siswa
                    if (isFirebaseReady) {
                        await updateDoc(doc(db, 'siswa', editId), siswaData);
                    }
                    
                    // Update local data
                    const siswaIndex = dataSiswa.findIndex(s => s.id === editId);
                    if (siswaIndex !== -1) {
                        dataSiswa[siswaIndex] = { id: editId, ...siswaData };
                    }
                    
                    alert('‚úÖ Data siswa berhasil diupdate!');
                } else {
                    // Add mode - create new siswa
                    if (isFirebaseReady) {
                        // Add to Firebase
                        const docRef = await addDoc(collection(db, 'siswa'), siswaData);
                        
                        // Update local data
                        dataSiswa.push({ id: docRef.id, ...siswaData });
                    } else {
                        // Offline mode
                        siswaData.id = Date.now().toString();
                        dataSiswa.push(siswaData);
                    }
                    
                    alert('‚úÖ Data siswa berhasil disimpan!');
                }
                
                loadSiswaTable();
                closeAddSiswaModal();
                
            } catch (error) {
                console.error('‚ùå Error saving siswa:', error);
                alert('Gagal menyimpan data siswa: ' + error.message);
            }
        });

        // Guru Functions
        function showGuruSection(section, evt) {
            // Hide all guru sections
            document.querySelectorAll('.guru-section').forEach(s => s.classList.add('hidden'));

            // Build section id (sama seperti sebelumnya)
            const sectionId = `guru${section.charAt(0).toUpperCase() + section.slice(1)}Section`;
            const sectionEl = document.getElementById(sectionId);
            if (sectionEl) sectionEl.classList.remove('hidden');

            // Update navigation active kelas
            document.querySelectorAll('.guru-nav-btn').forEach(btn => btn.classList.remove('bg-blue-700'));

            // Jika pemanggil menyediakan event target (mis. klik), pakai itu
            if (evt && evt.target) {
                evt.target.classList.add('bg-blue-700');
                return;
            }

            // Jika dipanggil programatik (mis. dari showDashboard), cari tombol yang memanggil fungsi ini
            // Mencari <button onclick="showGuruSection('input')"> atau yg setara
            const selector = `button[onclick="showGuruSection('${section}')"], button[onclick="showGuruSection(\\'${section}\\')"]`;
            const btn = document.querySelector(selector);
            if (btn) {
                btn.classList.add('bg-blue-700');
                return;
            }

            // fallback: jika ada tombol beratribut data-section
            const btn2 = document.querySelector(`.guru-nav-btn[data-section="${section}"]`);
            if (btn2) btn2.classList.add('bg-blue-700');
        }

        function loadGuruData() {
            // Load mata pelajaran for current guru
            const select = document.getElementById('mapelSelect');
            select.innerHTML = '<option value="">Pilih Mata Pelajaran</option>';
            
            if (currentUser.data && currentUser.data.mapel) {
                const mapelList = Array.isArray(currentUser.data.mapel) ? currentUser.data.mapel : [currentUser.data.mapel];
                mapelList.forEach(mapel => {
                    const option = document.createElement('option');
                    option.value = mapel;
                    option.textContent = mapel;
                    select.appendChild(option);
                });
                console.log('‚úÖ Loaded mapel for guru:', mapelList);
            }
            
            // Update debug counters
            updateDebugCounters();
        }

        function updateDebugCounters() {
            const siswaCountEl = document.getElementById('debugSiswaCount');
            const nilaiCountEl = document.getElementById('debugNilaiCount');
            
            if (siswaCountEl) siswaCountEl.textContent = dataSiswa.length;
            if (nilaiCountEl) nilaiCountEl.textContent = dataNilai.length;
            
            console.log('üìä Data counts:', {
                guru: dataGuru.length,
                siswa: dataSiswa.length,
                nilai: dataNilai.length
            });
        }

        function debugShowData() {
            console.log('üîç DEBUG DATA:');
            console.log('Guru:', dataGuru);
            console.log('Siswa:', dataSiswa);
            console.log('Nilai:', dataNilai);
            console.log('Current User:', currentUser);
            
            // Show sample data for testing
            if (dataSiswa.length === 0) {
                console.log('‚ö†Ô∏è No siswa data found. Adding sample data...');
                dataSiswa.push({
                    id: 'sample1',
                    nis: '2024001',
                    nama: 'Test Student',
                    kelas: 'VII A',
                    nisn: '1234567890',
                    ttl: 'Jakarta, 1 Januari 2010',
                    waliKelas: 'Test Teacher'
                });
                updateDebugCounters();
                console.log('‚úÖ Sample siswa added');
            }
        }

        function loadSiswaForNilai() {
            const mapel = document.getElementById('mapelSelect').value;
            const kelas = document.getElementById('kelasSelect').value;
            const sortBy = document.getElementById('sortSelect')?.value || 'nama_asc';
            
            if (mapel && kelas) {
                const siswaKelas = dataSiswa.filter(s => s.kelas === kelas);
                const tbody = document.getElementById('nilaiTableBody');
                tbody.innerHTML = '';

                // üîπ Urutkan sesuai pilihan
                let sortedSiswa = [...siswaKelas];
                if (sortBy === "nama_asc") {
                    sortedSiswa.sort((a, b) => (a.nama || "").localeCompare(b.nama || "", 'id', { sensitivity: 'base' }));
                } else if (sortBy === "nama_desc") {
                    sortedSiswa.sort((a, b) => (b.nama || "").localeCompare(a.nama || "", 'id', { sensitivity: 'base' }));
                } else if (sortBy === "nis") {
                    sortedSiswa.sort((a, b) => (a.nis || "").localeCompare(b.nis || "", 'id', { sensitivity: 'base' }));
                }

                sortedSiswa.forEach((siswa, index) => {
                    const asesmen = document.getElementById('asesmenSelect').value;
                    const existingNilai = dataNilai.find(n => 
                        n.nis === siswa.nis && n.mapel === mapel && n.asesmen === asesmen
                    );
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="border border-gray-300 px-4 py-2">${index + 1}</td>
                        <td class="border border-gray-300 px-4 py-2">${siswa.nis}</td>
                        <td class="border border-gray-300 px-4 py-2">${siswa.nama}</td>
                        <td class="border border-gray-300 px-4 py-2">
                            <input type="number" min="0" max="100" class="w-full px-2 py-1 border border-gray-300 rounded" 
                                id="nilai_${siswa.nis}" placeholder="0-100" value="${existingNilai ? existingNilai.nilai : ''}">
                        </td>
                        <td class="border border-gray-300 px-4 py-2">
                            <input type="text" class="w-full px-2 py-1 border border-gray-300 rounded" 
                                id="deskripsi_${siswa.nis}" placeholder="Deskripsi nilai" value="${existingNilai ? existingNilai.deskripsi : ''}">
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                document.getElementById('nilaiInputArea').classList.remove('hidden');
            } else {
                document.getElementById('nilaiInputArea').classList.add('hidden');
            }
        }


        // Simpan Nilai ke Firebase (DIPERBAIKI: Mengambil data docId dari objek 'n')
        async function simpanNilai() { 
            // Ambil nilai dari elemen SELECT (untuk filter data)
            const currentMapel = document.getElementById('mapelSelect').value;
            const currentKelas = document.getElementById('kelasSelect').value;
            const currentAsesmen = document.getElementById('asesmenSelect').value;

            if (!currentMapel || !currentKelas || !currentAsesmen) {
                alert("‚ö†Ô∏è Pilih mapel, kelas, dan asesmen dulu!");
                return;
            }

            // Filter data yang akan disimpan berdasarkan pilihan di form
            const nilaiToSave = dataNilai.filter(n => 
                n.mapel === currentMapel && n.asesmen === currentAsesmen
            );

            if (nilaiToSave.length === 0) {
                alert("‚ö†Ô∏è Tidak ada data nilai untuk disimpan.");
                return;
            }

            let successCount = 0;
            let errorCount = 0;

            // Proses penyimpanan secara paralel (Promise.all)
            const savePromises = nilaiToSave.map(n => {
                // ‚ö†Ô∏è PENTING: Lakukan validasi nis di sini, jika kosong, nisStr akan undefined/string kosong
                const nisStr = String(n.nis || "").trim(); 
                
                if (!nisStr) {
                    console.error("‚ùå Data invalid, NIS kosong:", n);
                    errorCount++;
                    return Promise.resolve();
                }

                // üí° PERBAIKAN: Pastikan mapel dan asesmen juga ada (meski sudah difilter, ini untuk keamanan)
                // Kita gunakan data dari objek 'n', bukan variabel 'currentMapel'/'currentAsesmen'
                const mapelDoc = n.mapel || currentMapel;
                const asesmenDoc = n.asesmen || currentAsesmen;
                
                // Buat ID dokumen. Jika salah satu (nisStr, mapelDoc, asesmenDoc) undefined/null,
                // akan menghasilkan string kosong yang menyebabkan error di doc()
                const docId = `${nisStr}_${mapelDoc}_${asesmenDoc}`;
                
                // Cek final sebelum kirim ke Firebase
                if (!docId.trim() || docId.includes('undefined') || docId.includes('null')) {
                    console.error(`‚ùå Gagal buat Doc ID: ${docId}`, n);
                    errorCount++;
                    return Promise.resolve();
                }
                
                const nilaiDocRef = doc(db, "nilai", docId); 

                return setDoc(nilaiDocRef, {
                    nis: nisStr,
                    mapel: mapelDoc,
                    asesmen: asesmenDoc,
                    nilai: Number(n.nilai) || 0,
                    deskripsi: n.deskripsi || "",
                    guru: n.guru || (currentUser?.name || "Guru"),
                    kelas: currentKelas // Gunakan kelas yang dipilih
                })
                .then(() => {
                    console.log(`‚úÖ Nilai ${nisStr} berhasil disimpan: ${docId}`);
                    successCount++;
                })
                .catch(error => {
                    console.error(`‚ùå Error simpan nilai ${nisStr} (${docId}):`, error);
                    errorCount++;
                    // Tangkap error perizinan di sini:
                    if (error.code === 'permission-denied') {
                        alert(`üõë ERROR PERIZINAN: Pastikan Aturan Keamanan Firebase mengizinkan penulisan ke koleksi 'nilai'.`);
                    }
                });
            });

            await Promise.all(savePromises);

            alert(`‚úÖ Proses penyimpanan selesai: ${successCount} berhasil, ${errorCount} gagal/dilewati.`);
        }

        function loadSiswaForCetak() {
            const kelas = document.getElementById('cetakKelasSelect').value;
            const select = document.getElementById('cetakSiswaSelect');
            
            select.innerHTML = '<option value="">Pilih Siswa</option>';
            
            console.log('üîç Loading siswa for cetak, kelas:', kelas);
            console.log('üìä Total dataSiswa:', dataSiswa.length);
            
            if (kelas) {
                const siswaKelas = dataSiswa.filter(s => s.kelas === kelas);
                console.log('üë• Siswa in kelas:', siswaKelas);
                
                if (siswaKelas.length === 0) {
                    // Add sample data if no students found
                    console.log('‚ö†Ô∏è No students found, adding sample data...');
                    const sampleSiswa = [
                        {id: 'sample1', nis: '2024001', nama: 'Abdullah Rahman', kelas: kelas, nisn: '1234567890', ttl: 'Jakarta, 15 Januari 2010', waliKelas: 'Ahmad Fauzi'},
                        {id: 'sample2', nis: '2024002', nama: 'Fatimah Zahra', kelas: kelas, nisn: '1234567891', ttl: 'Bogor, 20 Februari 2010', waliKelas: 'Ahmad Fauzi'},
                        {id: 'sample3', nis: '2024003', nama: 'Muhammad Iqbal', kelas: kelas, nisn: '1234567892', ttl: 'Depok, 10 Maret 2010', waliKelas: 'Ahmad Fauzi'}
                    ];
                    
                    // Add sample nilai too
                    const sampleNilai = [
                        {id: 'n1', nis: '2024001', mapel: 'AKIDAH AKHLAK', asesmen: 'ASTS', nilai: 85, deskripsi: 'Baik', guru: 'Ahmad Fauzi'},
                        {id: 'n2', nis: '2024001', mapel: 'AKIDAH AKHLAK', asesmen: 'ASAS', nilai: 88, deskripsi: 'Sangat Baik', guru: 'Ahmad Fauzi'},
                        {id: 'n3', nis: '2024001', mapel: 'FIQIH', asesmen: 'ASTS', nilai: 82, deskripsi: 'Baik', guru: 'Ahmad Fauzi'},
                        {id: 'n4', nis: '2024001', mapel: 'FIQIH', asesmen: 'ASAS', nilai: 85, deskripsi: 'Baik', guru: 'Ahmad Fauzi'},
                        {id: 'n5', nis: '2024002', mapel: 'AKIDAH AKHLAK', asesmen: 'ASTS', nilai: 90, deskripsi: 'Sangat Baik', guru: 'Ahmad Fauzi'},
                        {id: 'n6', nis: '2024002', mapel: 'AKIDAH AKHLAK', asesmen: 'ASAS', nilai: 92, deskripsi: 'Sangat Baik', guru: 'Ahmad Fauzi'}
                    ];
                    
                    dataSiswa.push(...sampleSiswa);
                    dataNilai.push(...sampleNilai);
                    
                    // üîπ Urutkan sampleSiswa A‚ÄìZ
                    const sortedSample = [...sampleSiswa].sort((a, b) =>
                        (a.nama || "").localeCompare(b.nama || "", 'id', { sensitivity: 'base' })
                    );
                    
                    sortedSample.forEach(siswa => {
                        const option = document.createElement('option');
                        option.value = siswa.nis;
                        option.textContent = `${siswa.nama} (${siswa.nis})`;
                        select.appendChild(option);
                    });
                    
                    console.log('‚úÖ Added sample data for testing');
                } else {
                    // üîπ Urutkan siswaKelas A‚ÄìZ
                    const sortedSiswa = [...siswaKelas].sort((a, b) =>
                        (a.nama || "").localeCompare(b.nama || "", 'id', { sensitivity: 'base' })
                    );
                    
                    sortedSiswa.forEach(siswa => {
                        const option = document.createElement('option');
                        option.value = siswa.nis;
                        option.textContent = `${siswa.nama} (${siswa.nis})`;
                        select.appendChild(option);
                    });
                }
                
                console.log(`‚úÖ Loaded ${select.options.length - 1} siswa for kelas ${kelas}`);
                updateDebugCounters();
            }
        }


        function previewRaport() {
            const nis = document.getElementById('cetakSiswaSelect').value;
            if (!nis) {
                document.getElementById('raportPreview').classList.add('hidden');
                return;
            }

            const siswa = dataSiswa.find(s => s.nis === nis);
            if (!siswa) {
                alert('Data siswa tidak ditemukan!');
                return;
            }

            // üîπ Loop nilai
            let rowsNilai = "";
            dataMapel.forEach((mapel, i) => {
                const nilaiASTS = dataNilai.find(n => n.nis === nis && n.mapel === mapel && n.asesmen === 'ASTS');
                const nilaiASAS = dataNilai.find(n => n.nis === nis && n.mapel === mapel && n.asesmen === 'ASAS');
                let rataRata = "-";
                if (nilaiASTS && nilaiASAS) rataRata = Math.round((nilaiASTS.nilai + nilaiASAS.nilai) / 2);
                else if (nilaiASTS) rataRata = nilaiASTS.nilai;
                else if (nilaiASAS) rataRata = nilaiASAS.nilai;

                rowsNilai += `
                <tr>
                    <td class="center">${i + 1}</td>
                    <td>${mapel}</td>
                    <td class="center">${rataRata}</td>
                    <td>${nilaiASAS ? nilaiASAS.deskripsi : (nilaiASTS ? nilaiASTS.deskripsi : '-')}</td>
                </tr>
                `;
            });

            // üîπ Template raport baru
            const raportHTML = `
            <div class="page" id="raportContent">
                <!-- Header -->
                <div class="header">
                <div class="logo">
                    <img src="index/images/attaqwa.png" alt="Logo Sekolah" style="width:72px; height:72px; object-fit:contain;">
                </div>
                <div class="school-info">
                    <div class="title">KEMENTERIAN AGAMA REPUBLIK INDONESIA</div>
                    <div class="title" style="font-size:18px;">MTSS ATTAQWA 18</div>
                    <div class="subtitle">JL. KH. MUH MUSA TANAH TINGGI RT. 02/05 - Tarumajaya, Bekasi</div>
                </div>
                <div style="width:110px; text-align:center;">
                    <div style="font-size:12px;">Halaman</div>
                    <div style="font-size:18px; font-weight:bold;">1</div>
                </div>
                </div>

                <!-- Data Siswa -->
                <div class="meta">
                <div><strong>Nama:</strong> ${siswa.nama}<br><strong>NIS:</strong> ${siswa.nis}<br><strong>NISN:</strong> ${siswa.nisn}</div>
                <div><strong>Kelas:</strong> ${siswa.kelas}<br><strong>Tahun Ajaran:</strong> 2025/2026</div>
                <div><strong>TTL:</strong> ${siswa.ttl}<br><strong>Wali Kelas:</strong> ${siswa.waliKelas || '-'}</div>
                </div>

                <!-- Judul -->
                <div style="text-align:center; margin:6px 0 12px 0;">
                <div style="font-weight:bold; font-size:15px;">CAPAIAN HASIL BELAJAR</div>
                </div>

                <!-- Tabel Nilai -->
                <table class="values">
                <thead>
                    <tr>
                    <th>No</th>
                    <th>Mata Pelajaran / Capaian Kompetensi</th>
                    <th>Nilai Akhir</th>
                    <th>Capaian Kompetensi (Deskripsi)</th>
                    </tr>
                </thead>
                <tbody>${rowsNilai}</tbody>
                </table>

                <!-- Tanda Tangan -->
                <div class="signatures">
                <div class="sig" style="text-align:left;">
                    <div>Orang Tua/Wali</div>
                    <div class="name">(..........................)</div>
                </div>
                <div class="sig">
                    <div>Wali Kelas</div>
                    <div class="name">${siswa.waliKelas || '-'}</div>
                </div>
                <div class="sig" style="text-align:right;">
                    <div>Kepala Madrasah</div>
                    <div class="name">Drs. H. Asep Ahmad, M.Ed</div>
                </div>
                </div>

                <!-- Footer -->
                <div class="footer">
                Rapor Digital Madrasah ‚Äî Cetak: ${new Date().toLocaleDateString()}
                </div>
            </div>

            <!-- Tombol aksi -->
            <div class="text-center mt-6 no-print">
                <button onclick="cetakRaport()" class="bg-primary text-white px-6 py-3 rounded-lg">üñ®Ô∏è Cetak Raport</button>
                <button onclick="downloadRaportPDF()" class="bg-green-500 text-white px-6 py-3 rounded-lg">üìÑ Download PDF</button>
            </div>
            `;

            document.getElementById('raportPreview').innerHTML = raportHTML;
            document.getElementById('raportPreview').classList.remove('hidden');
        }

        function cetakRaport() {
            console.log('üñ®Ô∏è Cetak raport called');
            
            // Ensure raport content exists
            const raportContent = document.getElementById('raportContent');
            if (!raportContent) {
                alert('‚ùå Raport belum di-generate! Pilih siswa terlebih dahulu.');
                return;
            }
            
            // Add print-specific styles
            const printStyles = `
                <style>
                    @media print {
                        @page {
                            size: A4;
                            margin: 1cm;
                        }
                        
                        body * {
                            visibility: hidden;
                        }
                        
                        #raportContent, #raportContent * {
                            visibility: visible;
                        }
                        
                        #raportContent {
                            position: absolute;
                            left: 0;
                            top: 0;
                            width: 100%;
                            font-size: 12px;
                        }
                        
                        .no-print {
                            display: none !important;
                        }
                        
                        table {
                            page-break-inside: avoid;
                        }
                        
                        tr {
                            page-break-inside: avoid;
                        }
                    }
                </style>
            `;
            
            // Add styles to head if not already present
            if (!document.querySelector('#printStyles')) {
                const styleElement = document.createElement('style');
                styleElement.id = 'printStyles';
                styleElement.innerHTML = printStyles;
                document.head.appendChild(styleElement);
            }
            
            console.log('‚úÖ Print styles added, calling window.print()');
            
            // Small delay to ensure styles are applied
            setTimeout(() => {
                window.print();
            }, 100);
        }
        
        function downloadRaportPDF() {
            console.log('üìÑ Download PDF called');
            
            const raportContent = document.getElementById('raportContent');
            if (!raportContent) {
                alert('‚ùå Raport belum di-generate! Pilih siswa terlebih dahulu.');
                return;
            }
            
            // For now, just trigger print dialog
            // In a real implementation, you would use a PDF library like jsPDF
            alert('üìÑ Fitur download PDF akan segera tersedia. Untuk saat ini, gunakan tombol Cetak dan pilih "Save as PDF" di dialog print.');
            cetakRaport();
        }

        // Delete functions
        async function deleteGuru(id) {
            if (confirm('Yakin ingin menghapus data guru ini?')) {
                try {
                    if (isFirebaseReady) {
                        await deleteDoc(doc(db, 'guru', id));
                    }
                    dataGuru = dataGuru.filter(g => g.id !== id);
                    loadGuruTable();
                    loadMapelList();
                    loadWaliKelasOptions();
                    alert('‚úÖ Data guru berhasil dihapus!');
                } catch (error) {
                    console.error('‚ùå Error deleting guru:', error);
                    alert('Gagal menghapus data guru: ' + error.message);
                }
            }
        }

        async function deleteSiswa(id) {
            if (confirm('Yakin ingin menghapus data siswa ini?')) {
                try {
                    if (isFirebaseReady) {
                        await deleteDoc(doc(db, 'siswa', id));
                    }
                    dataSiswa = dataSiswa.filter(s => s.id !== id);
                    loadSiswaTable();
                    alert('‚úÖ Data siswa berhasil dihapus!');
                } catch (error) {
                    console.error('‚ùå Error deleting siswa:', error);
                    alert('Gagal menghapus data siswa: ' + error.message);
                }
            }
        }

        // Edit functions
        function editGuru(id) {
            const guru = dataGuru.find(g => g.id === id);
            if (!guru) return;
            
            // Fill form with existing data
            document.getElementById('guruNama').value = guru.nama;
            document.getElementById('guruJabatan').value = guru.jabatan;
            document.getElementById('guruUsername').value = guru.username;
            document.getElementById('guruPassword').value = guru.password;
            
            // Check appropriate mapel checkboxes
            const mapelList = Array.isArray(guru.mapel) ? guru.mapel : [guru.mapel];
            document.querySelectorAll('#mapelCheckboxes input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = mapelList.includes(checkbox.value);
            });
            
            // Change form to edit mode
            const form = document.getElementById('addGuruForm');
            form.setAttribute('data-edit-id', id);
            
            // Change button text
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.innerHTML = '‚úèÔ∏è Update ke Firebase';
            
            // Change modal title
            document.querySelector('#addGuruModal h3').textContent = 'Edit Data Guru';
            
            showAddGuruForm();
        }

        function editSiswa(id) {
            const siswa = dataSiswa.find(s => s.id === id);
            if (!siswa) return;
            
            // Fill form with existing data
            document.getElementById('siswaNIS').value = siswa.nis;
            document.getElementById('siswaNama').value = siswa.nama;
            document.getElementById('siswaKelas').value = siswa.kelas;
            document.getElementById('siswaNISN').value = siswa.nisn;
            document.getElementById('siswaTTL').value = siswa.ttl;
            
            // Change form to edit mode
            const form = document.getElementById('addSiswaForm');
            form.setAttribute('data-edit-id', id);
            
            // Change button text
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.innerHTML = '‚úèÔ∏è Update ke Firebase';
            
            // Change modal title
            document.querySelector('#addSiswaModal h3').textContent = 'Edit Data Siswa';
            
            showAddSiswaForm();
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9838e9c07054d9e8',t:'MTc1ODYxODY3MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
